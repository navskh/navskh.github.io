---
layout: post
title: NestJS - ì§„ì§œ NestJS ì‹œì‘ 21. Multerì™€ ë¯¸ë””ì–´ íŒŒì¼ ì„œë¹„ìŠ¤
subtitle : Nestjs
tags: [Study, Nestjs]
author: Young
comments : True
---

## multipart-form ë°ì´í„°

ë¯¸ë””ì–´ íŒŒì¼ì„ ë³´ë‚¼ ë•ŒëŠ” ì–´ë–»ê²Œ í•´ì•¼í•˜ëŠ”ê°€.


content-type ì´ë¼ê³ 

ë°ì´í„°ë¥¼ ë³´ë‚¼ ë•Œ í—¤ë”ì— ì„¤ì •í•˜ëŠ” ë¶€ë¶„ì´ ìˆë‹¤.

ì—¬ê¸°ë¥¼ multipart-form  ë°ì´í„°ë¡œ ì„¤ì •í•´ì•¼ í•œë‹¤.

## multer íŒ¨í‚¤ì§€ ì„¤ì¹˜

```
npm i -D @types/multer
```

ë‹¨ì¼ íŒŒì¼ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ”..

```ts
@Post('upload')
@UseInterceptors(FileInterceptor('file'))
uploadFile(@UploadedFile() file: Express.Multer.File) {
  console.log(file);
}
```

ìœ„ì™€ ê°™ì€ ì¸í„°ì…‰í„°ë¥¼ ì‚¬ìš©í•˜ë¼ê³  ë˜ì–´ìˆìŒ.

```ts
  @ApiOperation({ summary: 'ì´ë¯¸ì§€ ì—…ë¡œë“œ' })
  @Post('upload')
  @UseInterceptors(FileInterceptor('files'))
  uploadCatImg(@UploadedFiles() files: Array<Express.Multer.File>) {
    console.log(files);
    return 'uploadImg';
  }
```

ìœ„ì™€ ê°™ì´ ì‚¬ìš©í•˜ë©´ fileë“¤ì˜ ë°°ì—´ í˜•íƒœë¡œ ë°›ì„ ìˆ˜ ìˆê²Œ ëœë‹¤.

ë˜í•œ Moduleì— import ì‹œì¼œì¤˜ì•¼ í•œë‹¤.

```ts
MulterModule.register({dest: './upload'}),
```

dest ëŠ” destination ëª©ì ì§€ url ì„ ì…ë ¥í•´ì¤Œ.


upload í•´ë³´ë©´...

```json
{success: true, data: "uploadImg"}
```

ìœ„ì™€ ê°™ì´ ëœ¨ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ê·¸ëŸ¬ë©´ ì„œë²„ í´ë”ì˜ upload í´ë” ì•ˆì— ì´ë¯¸ì§€ê°€ ë“¤ì–´ê°€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![Alt text](../../assets/img/img%EC%A0%80%EC%9E%A5.png)

## multer options

```ts
import * as multer from 'multer';
import * as path from 'path';
import * as fs from 'fs';
import { MulterOptions } from '@nestjs/platform-express/multer/interfaces/multer-options.interface';

const createFolder = (folder: string) => {
  try {
    console.log('ğŸ’¾ Create a root uploads folder...');

    fs.mkdirSync(path.join(__dirname, '..', `uploads`));
  } catch (error) {
    console.log('The folder already exists...');
  }

  try {
    console.log(`ğŸ’¾ Create a ${folder} uploads folder...`);

    fs.mkdirSync(path.join(__dirname, '..', `uploads/${folder}`));
  } catch (error) {
    console.log(`The ${folder} folder already exists...`);
  }
};

const storage = (folder: string): multer.StorageEngine => {
  createFolder(folder);

  return multer.diskStorage({
    destination(req, file, cb) {
      //* ì–´ë””ì— ì €ì¥í•  ì§€
      const folderName = path.join(__dirname, '..', `uploads/${folder}`);
      cb(null, folderName);
    },

    filename(req, file, cb) {
      //* ì–´ë–¤ ì´ë¦„ìœ¼ë¡œ ì˜¬ë¦´ ì§€
      const ext = path.extname(file.originalname);
      const fileName = `${path.basename(
        file.originalname,
        ext,
      )}${Date.now()}${ext}`;
      cb(null, fileName);
    },
  });
};

export const multerOptions = (folder: string) => {
  const result: MulterOptions = {
    storage: storage(folder),
  };

  return result;
};
```

ìœ„ ì½”ë“œë¥¼ common/utils/multer.options.ts ì•ˆì— ë„£ì–´ë‘”ë‹¤.

í´ë” ë§Œë“¤ì–´ì£¼ê³ , íŒŒì¼ ëª… ë§Œë“¤ì–´ì£¼ëŠ” ë¡œì§ì„.

```ts
@UseInterceptors(FilesInterceptor('image', 10, multerOptions("cats")))
```

ìµœëŒ€ 10ê°œê¹Œì§€ ëœë‹¤.


ì¼ë‹¨ ì´ë¯¸ì§€ê°€ ì„œë²„ í”„ë¡œê·¸ë¨ ê²½ë¡œì— ë“¤ì–´ê°€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.


## MiddleWareë¥¼ ë§Œë“¤ì–´ì£¼ê¸°

ë°ì´í„°ë² ì´ìŠ¤ì—ëŠ” íŒŒì¼ì˜ ê²½ë¡œëª…ì´ ë“¤ì–´ê°€ìˆì–´ì•¼ í•œë‹¤.

ê·¸ ê²½ë¡œëª…ì„ ë„£ì–´ì£¼ê¸° ìœ„í•´ Middlewareë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.


ë¨¼ì € main.ts ì—ì„œ

```ts
app.useStaticAssets(path.join(__dirname, './common', 'uploads'), {
    prefix: '/media',
});
```

ì—¬ê¸°ì—ì„œ `useStaticAssets` ê°€ ì—†ë‹¤ê³  ì—ëŸ¬ê°€ ëœ° ê²ƒì´ë‹¤.
ì–˜ëŠ” express applicationì´ë¼ê³  ëª…ì‹œí•´ì¤˜ì•¼í•œë‹¤.

```ts
const app = await NestFactory.create<NestExpressApplication>(AppModule);
```

ìœ„ì˜ prefix: 'media' ì— ëŒ€í•˜ì—¬...

ì´ë ‡ê²Œ í•¨ìœ¼ë¡œì¨, 
// http://localhost:8000/media/cats/aaa.png 
ì— ì ‘ê·¼í•˜ì—¬ í•´ë‹¹ íŒŒì¼ì„ ê°€ì ¸ì˜¬ ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ê²ƒì´ë‹¤.

## ì´ì œ ë§ˆì§€ë§‰ìœ¼ë¡œ
controller ì—ì„œ

```ts
@ApiOperation({ summary: 'ì´ë¯¸ì§€ ì—…ë¡œë“œ' })
@Post('upload')
@UseInterceptors(FilesInterceptor('image', 10, multerOptions("cats")))
uploadCatImg(@UploadedFiles() files: Array<Express.Multer.File>) {
  console.log(files);
  // return 'uploadImg';

  return { images: `http://localhost:8000/media/cats/${files[0].filename}` };
}
```

ì¼ë‹¨ 0ë²ˆì§¸ ì¸ë±ìŠ¤ì— ìˆëŠ” filename ì„ ê¸°ë°˜ìœ¼ë¡œ ì €ì¥ì‹œì¼œì¤€ë‹¤.

ìŠ¤í‚¤ë§ˆì— default ì‚¬ì§„ ê°€ì ¸ì˜¤ë„ë¡ ìˆ˜ì •
```ts
@Prop({
  default:
    'https://raw.githubusercontent.com/amamov/teaching-nestjs-a-to-z/main/images/1.jpeg',
})
@IsString()
imgUrl: string;
```

ê·¸ë¦¬ê³ , readonlydataì— imgURL ì¶”ê°€

```ts
readonly readOnlyData: {
  id: string;
  email: string;
  name: string;
  imgUrl: string;
};
```
```ts
CatSchema.virtual('readOnlyData').get(function (this: Cat) {
  return {
    id: this.id,
    email: this.email,
    name: this.name,
    imgUrl: this.imgUrl,
  };
});
```

serviceì— ìˆëŠ” ë©”ì„œë“œ ê°€ì ¸ì˜¬ ê²ƒì´ë‹¤.

```ts
@ApiOperation({ summary: 'ì´ë¯¸ì§€ ì—…ë¡œë“œ' })
@UseInterceptors(FilesInterceptor('image', 10, multerOptions("cats")))
@UseGuards(JwtAuthGuard)
@Post('upload')
uploadCatImg(@UploadedFiles() files: Array<Express.Multer.File>, @CurrentUser() cat: Cat) {
  console.log(files);
  // return 'uploadImg';
  // return { images: `http://localhost:8000/media/cats/${files[0].filename}` };

  return this.catsService.uploadImg(cat, files);
}
```

```ts
async uploadImg(cat: Cat, files: Express.Multer.File[]) {
  const fileName = `cats/${files[0].filename}`;
  console.log(fileName);
  const newCat = await this.catsRepository.findByIdAndUpdateImg(
    cat.id,
    fileName,
  );
  console.log(newCat);
  return newCat;
}
```

ìœ„ì™€ ê°™ì´ êµ¬í˜„

ì´ì œ í´ë” ê´€ë¦¬ë¥¼ ì¢€ í•´ì¤˜ì•¼ í•´ì„œ
controllerë¥¼ ì¼ë‹¨ ë¹¼ì„œ ì •ë¦¬í•˜ì˜€ìŒ.


## ë³´ë„ˆìŠ¤ POSTMANì—ì„œ íŒŒì¼ì—…ë¡œë“œ í•˜ê¸°

form data ë¼ëŠ” ì• ì—ì„œ fileë¡œ ì„¤ì •í•˜ë©´ íŒŒì¼ì„ ì˜¬ë¦´ ìˆ˜ ìˆê²Œ ë˜ì–´ìˆìŒ

